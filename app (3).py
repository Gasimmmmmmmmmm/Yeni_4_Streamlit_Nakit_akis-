
import streamlit as st
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import warnings
import base64
import tempfile
import os
warnings.filterwarnings('ignore')

try:
    import tensorflow as tf
    from sklearn.preprocessing import MinMaxScaler
    TENSORFLOW_AVAILABLE = True
except ImportError:
    TENSORFLOW_AVAILABLE = False

# ==================== MODEL PATH CONFIGURATION ====================
MODEL_PATH = "model_embedded.txt"  # Google Colab i√ßin
# MODEL_PATH = "model_embedded.txt"  # Yerel i√ßin
# ================================================================

st.set_page_config(
    page_title="üí∞ Nakit Akƒ±≈ü Sistemi",
    page_icon="üí∞",
    layout="wide"
)

st.markdown("""
<style>
    .module-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1.5rem;
        border-radius: 10px;
        color: white;
        margin: 1rem 0;
    }
    .adaptive-card {
        border-left: 5px solid #28a745;
        padding: 1rem;
        background: #f8f9fa;
        margin: 0.5rem 0;
    }
    # .lstm-card {
    #     border-left: 5px solid #ffc107;
    #     padding: 1rem;
    #     background: #fffbf0;
    #     margin: 0.5rem 0;
    # }
    .warning-card {
        border-left: 5px solid #dc3545;
        padding: 1rem;
        background: #fff0f0;
        margin: 0.5rem 0;
    }
</style>
""", unsafe_allow_html=True)

if 'sistem' not in st.session_state:
    st.session_state.sistem = None
    st.session_state.initialized = False
    st.session_state.auto_refresh = True  # Otomatik yenileme i√ßin

class NakitAkisYonetimiTam:
    def __init__(self):
        self.hareketler = pd.DataFrame(columns=['Tarih', 'Aciklama', 'Kategori', 'Tutar', 'Tip', 'Hesap'])
        self.hesaplar = {}
        self.lstm_model = None
        self.model_yuklendi = False
        self.model_hata_mesaji = None
        
        # Otomatik analiz i√ßin √∂nbellek
        self.son_adaptif_analiz = None
        self.son_analiz_parametreleri = None
        
        if TENSORFLOW_AVAILABLE:
            self.scaler = MinMaxScaler(feature_range=(0, 1))
            self._dis_dosyadan_model_yukle()

    def _dis_dosyadan_model_yukle(self):
        """Dƒ±≈ü dosyadan Base64 model y√ºkleme"""
        try:
            if not os.path.exists(MODEL_PATH):
                self.model_hata_mesaji = f"‚ö†Ô∏è Model dosyasƒ± bulunamadƒ±: {MODEL_PATH}"
                st.info(f"{self.model_hata_mesaji}\n\nLSTM modeli olmadan sadece Adaptif ve Klasik analiz √ßalƒ±≈üacak.")
                return
            
            try:
                with open(MODEL_PATH, 'r', encoding='utf-8') as f:
                    model_base64_string = f.read().strip()
            except Exception as read_error:
                self.model_hata_mesaji = f"‚ùå Dosya okuma hatasƒ±: {str(read_error)}"
                st.error(self.model_hata_mesaji)
                return
            
            if not model_base64_string or len(model_base64_string) < 100:
                self.model_hata_mesaji = "‚ö†Ô∏è Model dosyasƒ± bo≈ü veya ge√ßersiz"
                st.warning(f"{self.model_hata_mesaji}\n\nL√ºtfen model_embedded.txt dosyasƒ±nƒ± kontrol edin.")
                return
            
            try:
                model_bytes = base64.b64decode(model_base64_string)
            except Exception as decode_error:
                self.model_hata_mesaji = f"‚ùå Base64 decode hatasƒ±: {str(decode_error)}"
                st.error(f"{self.model_hata_mesaji}\n\nDosya i√ßeriƒüi Base64 formatƒ±nda deƒüil.")
                return
            
            with tempfile.NamedTemporaryFile(delete=False, suffix='.h5') as tmp_file:
                tmp_file.write(model_bytes)
                tmp_path = tmp_file.name
            
            try:
                self.lstm_model = tf.keras.models.load_model(tmp_path, compile=False)
                self.model_yuklendi = True
                
                model_size_mb = len(model_bytes) / (1024 * 1024)
                st.success(f"‚úÖ LSTM Model ba≈üarƒ±yla y√ºklendi!\n- Dosya: {os.path.basename(MODEL_PATH)}\n- Boyut: {model_size_mb:.2f} MB\n- Katman sayƒ±sƒ±: {len(self.lstm_model.layers)}")
                
            except Exception as load_error:
                self.model_hata_mesaji = f"‚ùå Model y√ºkleme hatasƒ±: {str(load_error)}"
                st.error(f"{self.model_hata_mesaji}\n\nDosya bozuk veya uyumsuz bir model olabilir.")
            finally:
                try:
                    os.unlink(tmp_path)
                except:
                    pass
            
        except Exception as e:
            self.model_hata_mesaji = f"‚ùå Beklenmeyen hata: {str(e)}"
            st.error(self.model_hata_mesaji)
            self.model_yuklendi = False

    def csv_yukle(self, dosya, hesap_adi, baslangic_bakiye, tarih_sutun, tutar_sutun, aciklama_sutun):
        """CSV y√ºkleme"""
        try:
            if dosya is None:
                return False, "‚ùå Dosya se√ßilmedi", pd.DataFrame()

            df = pd.read_csv(dosya, encoding='utf-8-sig')
            df.columns = df.columns.str.strip()

            if tarih_sutun not in df.columns:
                return False, f"‚ùå '{tarih_sutun}' s√ºtunu bulunamadƒ±", pd.DataFrame()

            yeni_df = pd.DataFrame()
            yeni_df['Tarih'] = pd.to_datetime(df[tarih_sutun], errors='coerce')
            yeni_df['Tutar'] = pd.to_numeric(df[tutar_sutun], errors='coerce')
            yeni_df['Aciklama'] = df[aciklama_sutun] if aciklama_sutun in df.columns else 'ƒ∞≈ülem'

            yeni_df['Tip'] = yeni_df['Tutar'].apply(lambda x: 'Giris' if x > 0 else 'Cikis')
            yeni_df['Tutar'] = yeni_df['Tutar'].abs()
            yeni_df['Kategori'] = yeni_df['Aciklama'].apply(self._kategori_tahmin)
            yeni_df['Hesap'] = hesap_adi

            yeni_df = yeni_df.dropna(subset=['Tarih', 'Tutar'])

            if len(self.hareketler) == 0:
                self.hareketler = yeni_df.copy()
            else:
                self.hareketler = pd.concat([self.hareketler, yeni_df], ignore_index=True)

            self.hareketler = self.hareketler.sort_values('Tarih').reset_index(drop=True)
            self.hesaplar[hesap_adi] = float(baslangic_bakiye)

            return True, f"‚úÖ {len(yeni_df)} i≈ülem eklendi", yeni_df.head(10)

        except Exception as e:
            return False, f"‚ùå Hata: {str(e)}", pd.DataFrame()

    def _kategori_tahmin(self, aciklama):
        """Kategori tahmini"""
        aciklama_lower = str(aciklama).lower()
        if any(x in aciklama_lower for x in ['maas', 'maa≈ü']):
            return 'Maa≈ü'
        elif any(x in aciklama_lower for x in ['kira', 'rent']):
            return 'Kira'
        elif any(x in aciklama_lower for x in ['elektrik', 'su', 'gaz', 'fatura']):
            return 'Fatura'
        elif any(x in aciklama_lower for x in ['market']):
            return 'Market'
        else:
            return 'Diger'

    def manuel_islem_ekle(self, tarih, aciklama, kategori, tutar, tip, hesap):
        """Manuel i≈ülem ekleme + OTOMATƒ∞K YENƒ∞LEME"""
        try:
            yeni_hareket = pd.DataFrame([{
                'Tarih': pd.to_datetime(tarih),
                'Aciklama': aciklama,
                'Kategori': kategori,
                'Tutar': float(tutar),
                'Tip': tip,
                'Hesap': hesap
            }])

            if len(self.hareketler) == 0:
                self.hareketler = yeni_hareket.copy()
            else:
                self.hareketler = pd.concat([self.hareketler, yeni_hareket], ignore_index=True)

            self.hareketler = self.hareketler.sort_values('Tarih').reset_index(drop=True)
            
            # üî• YENƒ∞: Otomatik adaptif analizi yenile
            if self.son_analiz_parametreleri:
                self._otomatik_analiz_yenile()
            
            return True, f"‚úÖ Eklendi: {aciklama} - {tutar} TL"
        except Exception as e:
            return False, f"‚ùå Hata: {str(e)}"

    def _otomatik_analiz_yenile(self):
        """Otomatik adaptif analizi yenile"""
        if self.son_analiz_parametreleri:
            params = self.son_analiz_parametreleri
            pencereler, grafik, ozet, hata = self.adaptif_analiz(
                params['baslangic_tarihi'],
                params['bitis_tarihi'],
                params['baslangic_bakiye'],
                params['buffer_tutar'],
                params['min_yatirim_tutar']
            )
            if not hata:
                self.son_adaptif_analiz = {
                    'pencereler': pencereler,
                    'grafik': grafik,
                    'ozet': ozet
                }

    # ==================== MOD√úL 1: KLASƒ∞K ANALƒ∞Z ====================

    def klasik_analiz(self, baslangic_tarihi, bitis_tarihi, baslangic_bakiye, buffer_tutar):
        """Klasik nakit akƒ±≈ü analizi"""
        try:
            if len(self.hareketler) == 0:
                return None, None, None, None, "‚ö†Ô∏è Veri yok!"

            baslangic = pd.to_datetime(baslangic_tarihi)
            bitis = pd.to_datetime(bitis_tarihi)

            tarih_araligi = pd.date_range(start=baslangic, end=bitis, freq='D')
            bakiye_df = pd.DataFrame({'Tarih': tarih_araligi})
            bakiye_df['Bakiye'] = float(baslangic_bakiye)

            ilgili_hareketler = self.hareketler[
                (self.hareketler['Tarih'] >= baslangic) &
                (self.hareketler['Tarih'] <= bitis)
            ].copy()

            for idx in range(len(bakiye_df)):
                tarih = bakiye_df.loc[idx, 'Tarih']

                if idx > 0:
                    bakiye_df.loc[idx, 'Bakiye'] = bakiye_df.loc[idx-1, 'Bakiye']

                gunun_hareketleri = ilgili_hareketler[
                    ilgili_hareketler['Tarih'].dt.date == tarih.date()
                ]

                for _, hareket in gunun_hareketleri.iterrows():
                    if hareket['Tip'] == 'Giris':
                        bakiye_df.loc[idx, 'Bakiye'] += hareket['Tutar']
                    else:
                        bakiye_df.loc[idx, 'Bakiye'] -= hareket['Tutar']

            bakiye_df['Yatirilabilir'] = bakiye_df['Bakiye'].apply(lambda x: max(0, x - buffer_tutar))
            bakiye_df['Durum'] = bakiye_df['Bakiye'].apply(
                lambda x: 'üü¢ Fazla' if x > buffer_tutar else ('üü° Normal' if x >= 0 else 'üî¥ Acik')
            )

            oneriler_df = self._klasik_yatirim_onerileri(bakiye_df)
            grafik = self._klasik_grafik(bakiye_df, ilgili_hareketler)

            toplam_giris = ilgili_hareketler[ilgili_hareketler['Tip'] == 'Giris']['Tutar'].sum()
            toplam_cikis = ilgili_hareketler[ilgili_hareketler['Tip'] == 'Cikis']['Tutar'].sum()

            # üî• YENƒ∞: A√ßƒ±k tarihleri tespit et
            acik_gunler = bakiye_df[bakiye_df['Bakiye'] < 0]
            acik_detay = []
            if len(acik_gunler) > 0:
                for _, gun in acik_gunler.iterrows():
                    acik_detay.append({
                        'Tarih': gun['Tarih'].strftime('%Y-%m-%d'),
                        'Bakiye': gun['Bakiye']
                    })

            ozet = {
                'toplam_giris': toplam_giris,
                'toplam_cikis': toplam_cikis,
                'net_akis': toplam_giris - toplam_cikis,
                'min_bakiye': bakiye_df['Bakiye'].min(),
                'max_bakiye': bakiye_df['Bakiye'].max(),
                'acik_gun': len(bakiye_df[bakiye_df['Bakiye'] < 0]),
                'acik_detay': acik_detay  # üî• YENƒ∞
            }

            return bakiye_df, oneriler_df, grafik, ozet, None

        except Exception as e:
            return None, None, None, None, f"‚ùå Hata: {str(e)}"

    def _klasik_yatirim_onerileri(self, bakiye_df):
        """Klasik yatƒ±rƒ±m √∂nerileri"""
        oneriler = []
        i = 0
        while i < len(bakiye_df):
            yatirilabilir = bakiye_df.iloc[i]['Yatirilabilir']

            if yatirilabilir > 50:  # üî• YENƒ∞: 100'den 50'ye d√º≈ü√ºrd√ºk
                gun_sayisi = 1
                min_tutar = yatirilabilir

                for j in range(i+1, len(bakiye_df)):
                    if bakiye_df.iloc[j]['Yatirilabilir'] > 0:
                        gun_sayisi += 1
                        min_tutar = min(min_tutar, bakiye_df.iloc[j]['Yatirilabilir'])
                    else:
                        break

                if gun_sayisi >= 1:
                    yillik_faiz = 0.45
                    gunluk_faiz = yillik_faiz / 365
                    tahmini_getiri = min_tutar * (gunluk_faiz * gun_sayisi)

                    oneriler.append({
                        'Baslangic': bakiye_df.iloc[i]['Tarih'].strftime('%Y-%m-%d'),
                        'Gun': gun_sayisi,
                        'Tutar': f"{min_tutar:,.2f} TL",
                        'Getiri': f"{tahmini_getiri:,.2f} TL",
                        'Yatirim': self._yatirim_araci_sec(gun_sayisi)
                    })

                i += gun_sayisi
            else:
                i += 1

        return pd.DataFrame(oneriler) if oneriler else pd.DataFrame()

    def _klasik_grafik(self, bakiye_df, hareketler_df):
        """Klasik grafik + NEGATƒ∞F B√ñLGE VURGULU"""
        fig = make_subplots(
            rows=3, cols=1,
            subplot_titles=('üí∞ G√ºnl√ºk Bakiye', 'üíµ Yatƒ±rƒ±labilir', 'üìä Giri≈ü/√áƒ±kƒ±≈ü'),
            vertical_spacing=0.12,
            row_heights=[0.4, 0.3, 0.3]
        )

        # üî• YENƒ∞: Negatif bakiye b√∂lgelerini kƒ±rmƒ±zƒ± arka plan
        negatif_df = bakiye_df[bakiye_df['Bakiye'] < 0]
        for _, row in negatif_df.iterrows():
            fig.add_vrect(
                x0=row['Tarih'] - timedelta(hours=12),
                x1=row['Tarih'] + timedelta(hours=12),
                fillcolor="rgba(220, 53, 69, 0.2)",
                layer="below",
                line_width=0,
                row=1, col=1
            )

        fig.add_trace(
            go.Scatter(
                x=bakiye_df['Tarih'],
                y=bakiye_df['Bakiye'],
                mode='lines+markers',
                name='Bakiye',
                line=dict(color='#3498db', width=2),
                fill='tozeroy'
            ),
            row=1, col=1
        )

        fig.add_hline(y=0, line_dash="dash", line_color="red", row=1, col=1)

        fig.add_trace(
            go.Bar(
                x=bakiye_df['Tarih'],
                y=bakiye_df['Yatirilabilir'],
                name='Yatƒ±rƒ±labilir',
                marker_color='#2ecc71'
            ),
            row=2, col=1
        )

        if len(hareketler_df) > 0:
            gunluk_giris = hareketler_df[hareketler_df['Tip'] == 'Giris'].groupby(
                hareketler_df['Tarih'].dt.date
            )['Tutar'].sum()
            gunluk_cikis = hareketler_df[hareketler_df['Tip'] == 'Cikis'].groupby(
                hareketler_df['Tarih'].dt.date
            )['Tutar'].sum()

            if len(gunluk_giris) > 0:
                fig.add_trace(go.Bar(x=gunluk_giris.index, y=gunluk_giris.values, name='Giris', marker_color='#27ae60'), row=3, col=1)

            if len(gunluk_cikis) > 0:
                fig.add_trace(go.Bar(x=gunluk_cikis.index, y=-gunluk_cikis.values, name='Cikis', marker_color='#e74c3c'), row=3, col=1)

        fig.update_layout(height=1000, showlegend=True, template='plotly_white')
        return fig

    # ==================== MOD√úL 2: ADAPTƒ∞F PENCERE (GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û) ====================

    def adaptif_analiz(self, baslangic_tarihi, bitis_tarihi, baslangic_bakiye, buffer_tutar, min_yatirim_tutar):
        """Adaptif yatƒ±rƒ±m penceresi analizi - GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û"""
        try:
            if len(self.hareketler) == 0:
                return None, None, None, "‚ö†Ô∏è Veri yok!"

            baslangic = pd.to_datetime(baslangic_tarihi)
            bitis = pd.to_datetime(bitis_tarihi)

            tarih_araligi = pd.date_range(start=baslangic, end=bitis, freq='D')
            bakiye_df = pd.DataFrame({'Tarih': tarih_araligi})
            bakiye_df['Bakiye'] = float(baslangic_bakiye)

            ilgili_hareketler = self.hareketler[
                (self.hareketler['Tarih'] >= baslangic) &
                (self.hareketler['Tarih'] <= bitis)
            ].copy()

            for idx in range(len(bakiye_df)):
                tarih = bakiye_df.loc[idx, 'Tarih']

                if idx > 0:
                    bakiye_df.loc[idx, 'Bakiye'] = bakiye_df.loc[idx-1, 'Bakiye']

                gunun_hareketleri = ilgili_hareketler[
                    ilgili_hareketler['Tarih'].dt.date == tarih.date()
                ]

                for _, hareket in gunun_hareketleri.iterrows():
                    if hareket['Tip'] == 'Giris':
                        bakiye_df.loc[idx, 'Bakiye'] += hareket['Tutar']
                    else:
                        bakiye_df.loc[idx, 'Bakiye'] -= hareket['Tutar']

            bakiye_df['Yatirilabilir'] = bakiye_df['Bakiye'].apply(lambda x: max(0, x - buffer_tutar))

            pencereler = self._adaptif_pencereler_hesapla(bakiye_df, buffer_tutar, min_yatirim_tutar)
            
            # üî• YENƒ∞: A√ßƒ±k tarihleri tespit et
            acik_gunler = bakiye_df[bakiye_df['Bakiye'] < 0]
            acik_detay = []
            if len(acik_gunler) > 0:
                for _, gun in acik_gunler.iterrows():
                    acik_detay.append({
                        'Tarih': gun['Tarih'].strftime('%Y-%m-%d'),
                        'Bakiye': f"{gun['Bakiye']:,.2f} TL"
                    })
            
            grafik = self._adaptif_grafik_gelismis(bakiye_df, pencereler, acik_gunler)

            ozet = {
                'pencere_sayisi': len(pencereler),
                'toplam_yatirilabilir': pencereler['Yatirilabilir_Tutar'].sum() if not pencereler.empty else 0,
                'toplam_getiri': pencereler['Tahmini_Getiri'].sum() if not pencereler.empty else 0,
                'min_bakiye': bakiye_df['Bakiye'].min(),
                'max_bakiye': bakiye_df['Bakiye'].max(),
                'acik_gun_sayisi': len(acik_gunler),  # üî• YENƒ∞
                'acik_detay': acik_detay  # üî• YENƒ∞
            }

            # Parametreleri kaydet (otomatik yenileme i√ßin)
            self.son_analiz_parametreleri = {
                'baslangic_tarihi': baslangic_tarihi,
                'bitis_tarihi': bitis_tarihi,
                'baslangic_bakiye': baslangic_bakiye,
                'buffer_tutar': buffer_tutar,
                'min_yatirim_tutar': min_yatirim_tutar
            }

            return pencereler, grafik, ozet, None

        except Exception as e:
            return None, None, None, f"‚ùå Hata: {str(e)}"

    def _adaptif_pencereler_hesapla(self, bakiye_df, buffer_tutar, min_yatirim_tutar):
        """Dinamik pencere hesaplama"""
        pencereler = []

        i = 0
        while i < len(bakiye_df):
            baslangic_tarih = bakiye_df.iloc[i]['Tarih']
            baslangic_bakiye = bakiye_df.iloc[i]['Bakiye']
            yatirilabilir_baslangic = max(0, baslangic_bakiye - buffer_tutar)

            if yatirilabilir_baslangic < min_yatirim_tutar:
                i += 1
                continue

            gun_sayisi = 0
            min_yatirilabilir = yatirilabilir_baslangic

            for j in range(i, len(bakiye_df)):
                gelecek_bakiye = bakiye_df.iloc[j]['Bakiye']
                gelecek_yatirilabilir = max(0, gelecek_bakiye - buffer_tutar)

                min_yatirilabilir = min(min_yatirilabilir, gelecek_yatirilabilir)

                if gelecek_yatirilabilir < min_yatirim_tutar or gelecek_bakiye < buffer_tutar:
                    break

                gun_sayisi += 1

            if gun_sayisi >= 1:
                bitis_tarih = baslangic_tarih + timedelta(days=gun_sayisi-1)
                
                yillik_faiz = 0.45
                gunluk_faiz = yillik_faiz / 365
                tahmini_getiri = min_yatirilabilir * (gunluk_faiz * gun_sayisi)
                
                risk = self._risk_seviyesi(bakiye_df.iloc[i:i+gun_sayisi], buffer_tutar)

                pencereler.append({
                    'Pencere_No': len(pencereler) + 1,
                    'Baslangic': baslangic_tarih.strftime('%Y-%m-%d'),
                    'Bitis': bitis_tarih.strftime('%Y-%m-%d'),
                    'Gun': gun_sayisi,
                    'Yatirilabilir_Tutar': min_yatirilabilir,
                    'Yatirim_Araci': self._yatirim_araci_sec(gun_sayisi),
                    'Tahmini_Getiri': tahmini_getiri,
                    'Yillik_Getiri': (tahmini_getiri / min_yatirilabilir) * (365 / gun_sayisi) * 100 if min_yatirilabilir > 0 else 0,
                    'Risk': risk
                })

                i += gun_sayisi
            else:
                i += 1

        return pd.DataFrame(pencereler) if pencereler else pd.DataFrame()

    def _risk_seviyesi(self, pencere_df, buffer_tutar):
        """Risk seviyesi"""
        min_bakiye = pencere_df['Bakiye'].min()
        if min_bakiye > buffer_tutar * 2:
            return "üü¢ D√º≈ü√ºk"
        elif min_bakiye > buffer_tutar * 1.5:
            return "üü° Orta"
        elif min_bakiye > buffer_tutar:
            return "üü† Y√ºksek"
        else:
            return "üî¥ Kritik"

    def _yatirim_araci_sec(self, gun):
        """Yatƒ±rƒ±m aracƒ±"""
        if gun <= 1:
            return "üìä Overnight"
        elif gun <= 7:
            return "üìà Haftalƒ±k"
        elif gun <= 30:
            return "üè¶ Vadeli 1A"
        elif gun <= 90:
            return "üí∞ Vadeli 3A"
        else:
            return "üíé Vadeli 6A+"

    def _adaptif_grafik_gelismis(self, bakiye_df, pencereler_df, acik_gunler):
        """Adaptif grafik - GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û (Negatif b√∂lge vurgulu)"""
        fig = make_subplots(
            rows=2, cols=1,
            subplot_titles=('üí∞ Bakiye ve Yatƒ±rƒ±m Pencereleri', 'üíµ Yatƒ±rƒ±labilir Tutar'),
            vertical_spacing=0.15,
            row_heights=[0.6, 0.4]
        )

        # üî• YENƒ∞: Negatif bakiye b√∂lgelerini kƒ±rmƒ±zƒ± arka plan
        for _, row in acik_gunler.iterrows():
            fig.add_vrect(
                x0=row['Tarih'] - timedelta(hours=12),
                x1=row['Tarih'] + timedelta(hours=12),
                fillcolor="rgba(220, 53, 69, 0.3)",
                layer="below",
                line_width=0,
                row=1, col=1
            )
            # Uyarƒ± ikonu ekle
            fig.add_annotation(
                x=row['Tarih'],
                y=row['Bakiye'],
                text="‚ö†Ô∏è",
                showarrow=False,
                font=dict(size=20, color="red"),
                row=1, col=1
            )

        fig.add_trace(
            go.Scatter(
                x=bakiye_df['Tarih'],
                y=bakiye_df['Bakiye'],
                mode='lines',
                name='Bakiye',
                line=dict(color='#3498db', width=2),
                fill='tozeroy'
            ),
            row=1, col=1
        )

        # üî• YENƒ∞: Yatƒ±rƒ±m pencerelerini ye≈üil kutular
        if not pencereler_df.empty:
            for _, pencere in pencereler_df.iterrows():
                baslangic = pd.to_datetime(pencere['Baslangic'])
                bitis = pd.to_datetime(pencere['Bitis'])
                tutar = pencere['Yatirilabilir_Tutar']
                
                fig.add_shape(
                    type="rect",
                    x0=baslangic, x1=bitis,
                    y0=0, y1=tutar,
                    fillcolor="rgba(40, 167, 69, 0.3)",
                    line=dict(color="rgba(40, 167, 69, 0.7)", width=2),
                    row=1, col=1
                )
                
                fig.add_annotation(
                    x=baslangic + (bitis - baslangic) / 2,
                    y=tutar * 0.5,
                    text=f"üí∞ {tutar:,.0f}TL<br>{pencere['Gun']}g",
                    showarrow=False,
                    font=dict(size=9, color="green"),
                    row=1, col=1
                )

        fig.add_trace(
            go.Bar(
                x=bakiye_df['Tarih'],
                y=bakiye_df['Yatirilabilir'],
                name='Yatƒ±rƒ±labilir',
                marker_color='#2ecc71'
            ),
            row=2, col=1
        )

        fig.update_layout(height=900, showlegend=True, template='plotly_white')
        return fig

    # ==================== MOD√úL 3: LSTM TAHMƒ∞N ====================

    def lstm_tahmin(self, tahmin_gun_sayisi, baslangic_bakiye, lookback=30):
        """LSTM bakiye tahmini"""
        if not TENSORFLOW_AVAILABLE:
            return None, None, "‚ùå TensorFlow y√ºkl√º deƒüil!"

        try:
            if not self.model_yuklendi or self.lstm_model is None:
                return None, None, self.model_hata_mesaji or "‚ùå Model y√ºklenemedi!"

            if len(self.hareketler) == 0:
                return None, None, "‚ùå Veri yok!"

            bakiye_serisi = self._gunluk_bakiye_olustur(baslangic_bakiye)

            if bakiye_serisi is None or len(bakiye_serisi) < lookback:
                return None, None, f"‚ùå En az {lookback} g√ºn veri gerekli!"

            bakiye_degerleri = bakiye_serisi['Bakiye'].values.reshape(-1, 1)
            normalized_data = self.scaler.fit_transform(bakiye_degerleri)

            son_veri = normalized_data[-lookback:]

            tahminler = []
            mevcut_veri = son_veri.copy()

            for _ in range(tahmin_gun_sayisi):
                X_test = mevcut_veri.reshape(1, lookback, 1)
                tahmin = self.lstm_model.predict(X_test, verbose=0)
                tahminler.append(tahmin[0, 0])
                mevcut_veri = np.append(mevcut_veri[1:], tahmin)

            tahminler = np.array(tahminler).reshape(-1, 1)
            tahminler_gercek = self.scaler.inverse_transform(tahminler)

            son_tarih = bakiye_serisi['Tarih'].max()
            tahmin_tarihleri = pd.date_range(
                start=son_tarih + timedelta(days=1),
                periods=tahmin_gun_sayisi,
                freq='D'
            )

            tahmin_df = pd.DataFrame({
                'Tarih': tahmin_tarihleri,
                'Tahmin_Bakiye': tahminler_gercek.flatten()
            })

            grafik = self._lstm_grafik(bakiye_serisi, tahmin_df)

            ozet = {
                'tahmin_suresi': tahmin_gun_sayisi,
                'ortalama': tahminler_gercek.mean(),
                'minimum': tahminler_gercek.min(),
                'maximum': tahminler_gercek.max(),
                'risk': 'Y√ºksek' if tahminler_gercek.min() < 0 else 'D√º≈ü√ºk'
            }

            return tahmin_df, grafik, ozet

        except Exception as e:
            return None, None, f"‚ùå Hata: {str(e)}"

    def _gunluk_bakiye_olustur(self, baslangic_bakiye):
        """G√ºnl√ºk bakiye serisi"""
        if len(self.hareketler) == 0:
            return None

        min_tarih = self.hareketler['Tarih'].min()
        max_tarih = self.hareketler['Tarih'].max()

        tarih_araligi = pd.date_range(start=min_tarih, end=max_tarih, freq='D')
        bakiye_serisi = pd.DataFrame({'Tarih': tarih_araligi, 'Bakiye': float(baslangic_bakiye)})

        for idx in range(len(bakiye_serisi)):
            if idx > 0:
                bakiye_serisi.loc[idx, 'Bakiye'] = bakiye_serisi.loc[idx-1, 'Bakiye']

            tarih = bakiye_serisi.loc[idx, 'Tarih']
            gunun_hareketleri = self.hareketler[self.hareketler['Tarih'].dt.date == tarih.date()]

            for _, hareket in gunun_hareketleri.iterrows():
                if hareket['Tip'] == 'Giris':
                    bakiye_serisi.loc[idx, 'Bakiye'] += hareket['Tutar']
                else:
                    bakiye_serisi.loc[idx, 'Bakiye'] -= hareket['Tutar']

        return bakiye_serisi

    def _lstm_grafik(self, gercek_veri, tahmin_veri):
        """LSTM grafik"""
        fig = go.Figure()

        fig.add_trace(
            go.Scatter(
                x=gercek_veri['Tarih'],
                y=gercek_veri['Bakiye'],
                mode='lines',
                name='Ger√ßek Bakiye',
                line=dict(color='#3498db', width=2)
            )
        )

        fig.add_trace(
            go.Scatter(
                x=tahmin_veri['Tarih'],
                y=tahmin_veri['Tahmin_Bakiye'],
                mode='lines+markers',
                name='LSTM Tahmini',
                line=dict(color='#e74c3c', width=2, dash='dash'),
                marker=dict(size=6)
            )
        )

        fig.add_hline(y=0, line_dash="dot", line_color="red")

        fig.update_layout(
            title="üîÆ LSTM Nakit Akƒ±≈ü Tahmini",
            xaxis_title="Tarih",
            yaxis_title="Bakiye (TL)",
            height=600,
            hovermode='x unified',
            template='plotly_white'
        )

        return fig

def main():
    st.title("üí∞ Nakit Akƒ±≈ü Y√∂netim Sistemi - Tam Adaptif Versiyon")
    st.markdown("### üéØ 3 Mod√ºl: Adaptif Pencere | LSTM Tahmin | Klasik Analiz")
    st.markdown("#### üî• **YENƒ∞:** Otomatik Yenileme | A√ßƒ±k Tarih G√∂sterimi | Geli≈ümi≈ü Grafikler")
    
    if not st.session_state.initialized:
        st.session_state.sistem = NakitAkisYonetimiTam()
        st.session_state.initialized = True
    
    sistem = st.session_state.sistem
    
    # Sidebar
    with st.sidebar:
        st.header("‚öôÔ∏è Sistem Durumu")
        
        if TENSORFLOW_AVAILABLE and sistem.model_yuklendi:
            st.success("‚úÖ LSTM Hazƒ±r")
        elif TENSORFLOW_AVAILABLE:
            st.warning("‚ö†Ô∏è Model Yok")
            if sistem.model_hata_mesaji:
                st.caption(sistem.model_hata_mesaji)
        else:
            st.error("‚ùå TensorFlow Yok")
        
        st.divider()
        
        st.caption(f"üìÇ Model Path:\n`{MODEL_PATH}`")
        
        st.divider()
        
        if len(sistem.hareketler) > 0:
            st.metric("üìä Toplam ƒ∞≈ülem", len(sistem.hareketler))
            st.metric("üè¶ Hesap Sayƒ±sƒ±", len(sistem.hesaplar))
            
            st.divider()
            st.subheader("üîÑ Otomatik Yenileme")
            if sistem.son_analiz_parametreleri:
                st.success("‚úÖ Aktif")
                st.caption("Manuel i≈ülem eklendiƒüinde\nadaptif analiz otomatik g√ºncellenir")
            else:
                st.info("‚ÑπÔ∏è Pasif")
                st.caption("Adaptif analizi bir kez √ßalƒ±≈ütƒ±rƒ±n")
        else:
            st.info("üì≠ Veri yok")
    
    # Tabs
    tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs([
        "üì§ Veri",
        "üí∞ Klasik Analiz",
        "üéØ Adaptif Pencere",
        "üîÆ LSTM Tahmin",
        "üìã ƒ∞≈ülemler",
        "‚ùì Yardƒ±m"
    ])
    
    # TAB 1: VERƒ∞ Y√úKLE
    with tab1:
        st.header("üì§ Veri Y√∂netimi")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.subheader("CSV Y√ºkle")
            csv_file = st.file_uploader("Dosya", type=['csv'])
            hesap_adi = st.text_input("Hesap", value="Ana Hesap")
            baslangic_bakiye = st.number_input("Ba≈ülangƒ±√ß Bakiyesi", value=10000.0)
            
            col_a, col_b, col_c = st.columns(3)
            with col_a:
                tarih_sutun = st.text_input("Tarih S√ºtunu", value="Tarih")
            with col_b:
                tutar_sutun = st.text_input("Tutar S√ºtunu", value="Tutar")
            with col_c:
                aciklama_sutun = st.text_input("A√ßƒ±klama", value="Aciklama")
            
            if st.button("üì• Y√ºkle", type="primary", use_container_width=True):
                if csv_file:
                    success, mesaj, ozet = sistem.csv_yukle(
                        csv_file, hesap_adi, baslangic_bakiye,
                        tarih_sutun, tutar_sutun, aciklama_sutun
                    )
                    if success:
                        st.success(mesaj)
                        st.dataframe(ozet, use_container_width=True)
                    else:
                        st.error(mesaj)
        
        with col2:
            st.subheader("Manuel ƒ∞≈ülem Ekle")
            st.info("üî• **YENƒ∞:** ƒ∞≈ülem eklediƒüinizde adaptif analiz otomatik g√ºncellenir!")
            
            m_tarih = st.date_input("Tarih", value=datetime.now())
            m_aciklama = st.text_input("A√ßƒ±klama", placeholder="√ñrn: Kira √∂demesi")
            m_kategori = st.selectbox("Kategori", ["Maa≈ü", "Kira", "Fatura", "Market", "Diger"])
            
            col_d, col_e = st.columns(2)
            with col_d:
                m_tutar = st.number_input("Tutar (TL)", value=0.0, min_value=0.0)
                m_tip = st.radio("ƒ∞≈ülem Tipi", ["Giris", "Cikis"])
            with col_e:
                m_hesap = st.text_input("Hesap", value="Kasa")
            
            if st.button("‚ûï ƒ∞≈ülem Ekle", type="secondary", use_container_width=True):
                if m_aciklama and m_tutar > 0:
                    success, mesaj = sistem.manuel_islem_ekle(
                        m_tarih, m_aciklama, m_kategori, m_tutar, m_tip, m_hesap
                    )
                    if success:
                        st.success(mesaj)
                        if sistem.son_analiz_parametreleri:
                            st.info("üîÑ Adaptif analiz otomatik g√ºncellendi!")
                    else:
                        st.error(mesaj)
                else:
                    st.warning("‚ö†Ô∏è A√ßƒ±klama ve tutar zorunludur!")
    
    # TAB 2: KLASƒ∞K ANALƒ∞Z
    with tab2:
        st.header("üí∞ Klasik Nakit Akƒ±≈ü Analizi")
        
        if len(sistem.hareketler) == 0:
            st.warning("‚ö†Ô∏è √ñnce veri y√ºkleyin")
        else:
            st.info("üìå Basit bakiye takibi ve g√ºnl√ºk yatƒ±rƒ±labilir tutar hesaplama")
            
            col1, col2, col3 = st.columns(3)
            with col1:
                k_baslangic = st.date_input("Ba≈ülangƒ±√ß", value=datetime.now(), key="k_bas")
            with col2:
                k_bitis = st.date_input("Biti≈ü", value=datetime.now() + timedelta(days=30), key="k_bit")
            with col3:
                k_bakiye = st.number_input("Bakiye", value=10000.0, key="k_bak")
            
            k_buffer = st.number_input("Buffer (TL)", value=1000.0, help="Elde tutmak istediƒüiniz minimum tutar", key="k_buf")
            
            if st.button("üìä KLASƒ∞K ANALƒ∞Z", type="primary", use_container_width=True):
                with st.spinner("Hesaplanƒ±yor..."):
                    bakiye_df, oneriler, grafik, ozet, hata = sistem.klasik_analiz(
                        k_baslangic, k_bitis, k_bakiye, k_buffer
                    )
                    
                    if grafik:
                        col1, col2, col3, col4 = st.columns(4)
                        with col1:
                            st.metric("Toplam Giri≈ü", f"{ozet['toplam_giris']:,.0f} TL")
                        with col2:
                            st.metric("Toplam √áƒ±kƒ±≈ü", f"{ozet['toplam_cikis']:,.0f} TL")
                        with col3:
                            st.metric("Net Akƒ±≈ü", f"{ozet['net_akis']:,.0f} TL")
                        with col4:
                            acik_gun = ozet['acik_gun']
                            st.metric("A√ßƒ±k G√ºn", acik_gun, delta="‚ö†Ô∏è" if acik_gun > 0 else "‚úÖ")
                        
                        # üî• YENƒ∞: A√ßƒ±k g√ºnler detayƒ±
                        if ozet['acik_detay']:
                            st.markdown("---")
                            st.subheader("‚ö†Ô∏è Negatif Bakiye Uyarƒ±larƒ±")
                            for acik in ozet['acik_detay']:
                                st.markdown(f"""
                                <div class="warning-card">
                                    <strong>üî¥ {acik['Tarih']}</strong>: Bakiye {acik['Bakiye']:,.2f} TL
                                </div>
                                """, unsafe_allow_html=True)
                        
                        st.plotly_chart(grafik, use_container_width=True)
                        
                        if not oneriler.empty:
                            st.subheader("üíé Yatƒ±rƒ±m √ñnerileri")
                            st.dataframe(oneriler, use_container_width=True)
                    else:
                        st.error(hata)
    
    # TAB 3: ADAPTƒ∞F PENCERE
    with tab3:
        st.header("üéØ Adaptif Yatƒ±rƒ±m Penceresi")
        
        if len(sistem.hareketler) == 0:
            st.warning("‚ö†Ô∏è √ñnce veri y√ºkleyin")
        else:
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                a_baslangic = st.date_input("Ba≈ülangƒ±√ß", value=datetime.now(), key="a_bas")
            with col2:
                a_bitis = st.date_input("Biti≈ü", value=datetime.now() + timedelta(days=30), key="a_bit")
            with col3:
                a_bakiye = st.number_input("Ba≈ülangƒ±√ß Bakiyesi", value=10000.0, key="a_bak")
            with col4:
                a_buffer = st.number_input("Buffer Tutarƒ±", value=1000.0, key="a_buf")
            
            a_min_yatirim = st.slider("Minimum Yatƒ±rƒ±m (TL)", 10, 500, 50, 10, 
                                      help="üî• YENƒ∞: 50 TL'ye d√º≈ü√ºr√ºld√º - k√º√ß√ºk tutarlar da g√∂sterilir")
            
            if st.button("üéØ ADAPTƒ∞F ANALƒ∞Z", type="primary", use_container_width=True):
                with st.spinner("Pencereler hesaplanƒ±yor..."):
                    pencereler, grafik, ozet, hata = sistem.adaptif_analiz(
                        a_baslangic, a_bitis, a_bakiye, a_buffer, a_min_yatirim
                    )
                    
                    if grafik:
                        col1, col2, col3, col4 = st.columns(4)
                        with col1:
                            st.metric("Pencere Sayƒ±sƒ±", ozet['pencere_sayisi'])
                        with col2:
                            st.metric("Toplam Yatƒ±rƒ±labilir", f"{ozet['toplam_yatirilabilir']:,.0f} TL")
                        with col3:
                            st.metric("Tahmini Getiri", f"{ozet['toplam_getiri']:,.2f} TL")
                        with col4:
                            acik = ozet['acik_gun_sayisi']
                            st.metric("A√ßƒ±k G√ºn", acik, delta="‚ö†Ô∏è" if acik > 0 else "‚úÖ")
                        
                        # üî• YENƒ∞: A√ßƒ±k g√ºnler detayƒ±
                        if ozet['acik_detay']:
                            st.markdown("---")
                            st.subheader("‚ö†Ô∏è Negatif Bakiye Uyarƒ±larƒ±")
                            cols = st.columns(3)
                            for idx, acik in enumerate(ozet['acik_detay']):
                                with cols[idx % 3]:
                                    st.markdown(f"""
                                    <div class="warning-card">
                                        <strong>üî¥ {acik['Tarih']}</strong><br>
                                        Bakiye: {acik['Bakiye']}
                                    </div>
                                    """, unsafe_allow_html=True)
                        
                        st.plotly_chart(grafik, use_container_width=True)
                        
                        if not pencereler.empty:
                            st.subheader("üíé Yatƒ±rƒ±m Pencereleri")
                            for _, p in pencereler.iterrows():
                                st.markdown(f"""
                                <div class="adaptive-card" style="background-color: black; color: white; padding: 15px; border-radius: 5px;">
                                    <h4>Pencere #{p['Pencere_No']}: {p['Baslangic']} ‚Üí {p['Bitis']}</h4>
                                    <p>üí∞ <strong>{p['Yatirilabilir_Tutar']:,.2f} TL</strong> | ‚è±Ô∏è {p['Gun']} g√ºn | üìä {p['Yatirim_Araci']}</p>
                                    <p>üíµ Getiri: {p['Tahmini_Getiri']:,.2f} TL (Yƒ±llƒ±k: %{p['Yillik_Getiri']:.2f}) | ‚ö†Ô∏è Risk: {p['Risk']}</p>
                                </div>
                                """, unsafe_allow_html=True)
                            
                            display_df = pencereler.copy()
                            display_df['Yatirilabilir_Tutar'] = display_df['Yatirilabilir_Tutar'].apply(lambda x: f"{x:,.2f}")
                            display_df['Tahmini_Getiri'] = display_df['Tahmini_Getiri'].apply(lambda x: f"{x:,.2f}")
                            display_df['Yillik_Getiri'] = display_df['Yillik_Getiri'].apply(lambda x: f"%{x:.2f}")
                            st.dataframe(display_df, use_container_width=True)
                        else:
                            st.info("üí° Pencere bulunamadƒ±. Buffer veya min yatƒ±rƒ±m tutarƒ±nƒ± azaltƒ±n.")
                    else:
                        st.error(hata)
    
    # TAB 4: LSTM TAHMƒ∞N
    with tab4:
        st.header("üîÆ LSTM Bakiye Tahmini")
        
        if not TENSORFLOW_AVAILABLE:
            st.error("‚ùå TensorFlow y√ºkl√º deƒüil!")
        elif not sistem.model_yuklendi:
            st.warning("‚ö†Ô∏è Model y√ºklenemedi.")
            if sistem.model_hata_mesaji:
                st.error(sistem.model_hata_mesaji)
            st.info("üí° Model dosyasƒ±nƒ± kontrol edin ve sayfayƒ± yenileyin.")
        elif len(sistem.hareketler) == 0:
            st.warning("‚ö†Ô∏è √ñnce veri y√ºkleyin")
        else:
            st.markdown("""

            """, unsafe_allow_html=True)
            
            col1, col2, col3 = st.columns(3)
            with col1:
                l_tahmin_gun = st.slider("Tahmin S√ºresi (G√ºn)", 1, 90, 30)
            with col2:
                l_bakiye = st.number_input("Ba≈ülangƒ±√ß Bakiyesi", value=10000.0, key="l_bak")
            with col3:
                l_lookback = st.slider("Lookback Period", 7, 60, 30)
            
            if st.button("üîÆ LSTM TAHMƒ∞N", type="primary", use_container_width=True):
                with st.spinner("AI hesaplƒ±yor..."):
                    tahmin_df, grafik, ozet = sistem.lstm_tahmin(
                        l_tahmin_gun, l_bakiye, l_lookback
                    )
                    
                    if isinstance(ozet, dict):
                        col1, col2, col3, col4 = st.columns(4)
                        with col1:
                            st.metric("Tahmin S√ºresi", f"{ozet['tahmin_suresi']} g√ºn")
                        with col2:
                            st.metric("Ort. Bakiye", f"{ozet['ortalama']:,.0f} TL")
                        with col3:
                            st.metric("Min Bakiye", f"{ozet['minimum']:,.0f} TL")
                        with col4:
                            risk_color = "üî¥" if ozet['risk'] == 'Y√ºksek' else "üü¢"
                            st.metric("A√ßƒ±k Riski", f"{risk_color} {ozet['risk']}")
                        
                        st.plotly_chart(grafik, use_container_width=True)
                        
                        st.subheader("üìã Tahmin Detaylarƒ±")
                        display_df = tahmin_df.copy()
                        display_df['Tarih'] = display_df['Tarih'].dt.strftime('%Y-%m-%d')
                        display_df['Tahmin_Bakiye'] = display_df['Tahmin_Bakiye'].apply(lambda x: f"{x:,.2f}")
                        display_df['Durum'] = tahmin_df['Tahmin_Bakiye'].apply(
                            lambda x: 'üü¢ Pozitif' if x >= 0 else 'üî¥ Negatif'
                        )
                        st.dataframe(display_df, use_container_width=True)
                    else:
                        st.error(ozet)
    
    # TAB 5: T√úM ƒ∞≈ûLEMLER
    with tab5:
        st.header("üìã T√ºm ƒ∞≈ülemler")
        
        if len(sistem.hareketler) == 0:
            st.info("Hen√ºz i≈ülem yok")
        else:
            df = sistem.hareketler.copy()
            df['Tarih'] = df['Tarih'].dt.strftime('%Y-%m-%d')
            df = df.sort_values('Tarih', ascending=False)
            
            st.dataframe(df, use_container_width=True, height=600)
            
            csv = df.to_csv(index=False, encoding='utf-8-sig')
            st.download_button(
                "üì• CSV ƒ∞ndir",
                data=csv,
                file_name=f"nakit_akis_{datetime.now().strftime('%Y%m%d')}.csv",
                mime="text/csv",
                use_container_width=True
            )
    
    # TAB 6: YARDIM
    with tab6:
        st.header("‚ùì Kullanƒ±m Kƒ±lavuzu - YENƒ∞ √ñZELLƒ∞KLER")
        
        st.markdown(f"""
        ## üî• Yeni √ñzellikler (v2.0)
        
        ### 1. ‚úÖ Otomatik Yenileme
        **Sorun:** Manuel i≈ülem eklenince "Adaptif Analiz" butonuna tekrar basmak gerekiyordu
        **√á√∂z√ºm:** Artƒ±k i≈ülem eklediƒüinizde analiz otomatik g√ºncellenir!
        
        **Nasƒ±l √áalƒ±≈üƒ±r:**
        1. Adaptif Analizi bir kez √ßalƒ±≈ütƒ±rƒ±n
        2. Manuel i≈ülem ekleyin
        3. ‚ú® Analiz otomatik yenilenir!
        
        ---
        
        ### 2. ‚ö†Ô∏è A√ßƒ±k Tarih G√∂sterimi
        **Sorun:** Sadece "5 g√ºn a√ßƒ±k" g√∂steriyordu, hangi tarihler belli deƒüildi
        **√á√∂z√ºm:** Artƒ±k negatif bakiye olan tarihleri g√∂rebilirsiniz!
        
        **√ñrnek √áƒ±ktƒ±:**
        ```
        ‚ö†Ô∏è Negatif Bakiye Uyarƒ±larƒ±
        üî¥ 2025-01-15: Bakiye -500 TL
        üî¥ 2025-01-16: Bakiye -300 TL
        ```
        
        ---
        
        ### 3. üìä Geli≈ümi≈ü Grafikler
        **Yeni:** Negatif bakiye b√∂lgeleri kƒ±rmƒ±zƒ± arka plan ile vurgulanƒ±r
        
        **Grafik √ñzellikleri:**
        - üü¢ Ye≈üil kutular = Yatƒ±rƒ±m pencereleri
        - üî¥ Kƒ±rmƒ±zƒ± arka plan = Negatif bakiye riski
        - ‚ö†Ô∏è ƒ∞konlar = A√ßƒ±k g√ºnler
        
        ---
        
        ### 4. üìâ Minimum Yatƒ±rƒ±m 50 TL'ye D√º≈üt√º
        **Eski:** 100 TL altƒ± g√∂sterilmiyordu
        **Yeni:** 50 TL'den ba≈ülƒ±yor - k√º√ß√ºk tutarlar da √∂nerilir
        
        **√ñrnek:**
        - "5-31 Ocak: 50 TL (26 g√ºn)" ‚úÖ Artƒ±k g√∂steriliyor
        
        ---
        
        ## üéØ Tam Senaryo √ñrneƒüi
        
        **Durum:**
        - 1 Ocak: 1000 TL bakiye
        - 1 Ocak: 50 TL √ßƒ±kƒ±≈ü ‚Üí Kalan: 950 TL
        - 5 Ocak: 900 TL √∂deme ‚Üí Kalan: 50 TL
        - Buffer: 0 TL
        
        **Sistem √áƒ±ktƒ±sƒ±:**
        ```
        Pencere #1: 2025-01-01 ‚Üí 2025-01-04
        üí∞ 950 TL | ‚è±Ô∏è 4 g√ºn | üìä Haftalƒ±k
        üíµ Getiri: 4.67 TL
        
        Pencere #2: 2025-01-05 ‚Üí 2025-01-31
        üí∞ 50 TL | ‚è±Ô∏è 26 g√ºn | üìä Vadeli 1A
        üíµ Getiri: 1.60 TL
        ```
        
        ---
        
        ## üìö Sistem Mod√ºlleri
        
        ### 1Ô∏è‚É£ Klasik Analiz
        - ‚úÖ Basit bakiye takibi
        - ‚úÖ G√ºnl√ºk yatƒ±rƒ±labilir tutar
        - ‚úÖ Giri≈ü/√ßƒ±kƒ±≈ü grafiƒüi
        - üî• **YENƒ∞:** A√ßƒ±k tarih g√∂sterimi
        - üéØ **Kullanƒ±m:** Hƒ±zlƒ± bakƒ±≈ü i√ßin
        
        ### 2Ô∏è‚É£ Adaptif Yatƒ±rƒ±m Penceresi ‚≠ê √ñNERƒ∞LEN
        - ‚úÖ Dinamik pencere hesaplama
        - ‚úÖ Her g√ºn i√ßin: ka√ß g√ºn, ne kadar?
        - ‚úÖ Risk analizi
        - ‚úÖ Optimum strateji
        - üî• **YENƒ∞:** Otomatik yenileme
        - üî• **YENƒ∞:** A√ßƒ±k tarih vurgulama
        - üî• **YENƒ∞:** 50 TL'den ba≈ülayan √∂neriler
        - üéØ **Kullanƒ±m:** Profesyonel yatƒ±rƒ±m planƒ± i√ßin
        
        ### 3Ô∏è‚É£ LSTM Tahmin
        - ‚úÖ AI bazlƒ± bakiye tahmini
        - ‚úÖ Gelecek projeksiyonu
        - ‚úÖ Risk uyarƒ±sƒ±
        - üéØ **Kullanƒ±m:** Uzun vadeli planlama i√ßin
        
        ---
        
        ## üöÄ Kullanƒ±m Adƒ±mlarƒ±
        
        ### Ba≈ülangƒ±√ß
        1. **Veri Y√ºkle** ‚Üí CSV veya manuel i≈ülem ekle
        2. **Adaptif Analiz** ‚Üí Pencereler hesapla
        3. **Otomatik Mod Aktif** ‚Üí Artƒ±k yeni i≈ülem eklediƒüinde otomatik g√ºncellenir
        
        ### Manuel ƒ∞≈ülem Eklerken
        ```
        Tarih: 2025-01-15
        A√ßƒ±klama: Kira √∂demesi
        Tutar: 1500 TL
        Tip: √áƒ±kƒ±≈ü
        
        [ƒ∞≈ülem Ekle] ‚úÖ
        ‚Üí üîÑ "Adaptif analiz otomatik g√ºncellendi!"
        ```
        
        ---
        
        ## üí° Hangi Mod√ºl√º Kullanmalƒ±yƒ±m?
        
        | Durum | √ñnerilen Mod√ºl |
        |-------|----------------|
        | Hƒ±zlƒ± bakiye kontrol√º | Klasik Analiz |
        | **Yatƒ±rƒ±m stratejisi** | **Adaptif Pencere** ‚≠ê |
        | Gelecek planlamasƒ± | LSTM Tahmin |
        | Kapsamlƒ± analiz | Adaptif + LSTM |
        | A√ßƒ±k risk tespiti | Klasik veya Adaptif (ikisinde de var) |
        
        ---
        
        ## üîß Sƒ±k Sorulan Sorular
        
        **S: "1-4 Ocak: 950 TL" neden 5 Ocak'a kadar deƒüil?**
        C: 5 Ocak'ta 900 TL √∂deme var, bu y√ºzden pencere 4'te kapanƒ±r. Buffer'ƒ±n altƒ±na d√º≈ümesin diye.
        
        **S: Otomatik yenileme √ßalƒ±≈ümƒ±yor?**
        C: Adaptif Analizi en az bir kez √ßalƒ±≈ütƒ±rmƒ±≈ü olmalƒ±sƒ±nƒ±z. Sidebar'da "‚úÖ Aktif" yazmalƒ±.
        
        **S: 50 TL'lik pencere g√∂sterilmiyor?**
        C: "Minimum Yatƒ±rƒ±m" slider'ƒ±nƒ± 50 TL'nin altƒ±na √ßekin.
        
        **S: A√ßƒ±k tarihler nerede g√∂r√ºn√ºyor?**
        C: Hem Klasik hem Adaptif analizde "‚ö†Ô∏è Negatif Bakiye Uyarƒ±larƒ±" ba≈ülƒ±ƒüƒ± altƒ±nda.
        
        **S: Grafikteki kƒ±rmƒ±zƒ± alanlar ne?**
        C: Negatif bakiye olan (a√ßƒ±k veren) g√ºnlerdir.
        
        **S: Buffer tutarƒ± ne olmalƒ±?**
        C: Aylƒ±k giderlerinizin 1-2 katƒ± √∂nerilir. √ñrnek: Aylƒ±k 5000 TL gider ‚Üí 5000-10000 TL buffer.
        
        **S: Adaptif vs Klasik farkƒ±?**
        C: 
        - **Klasik:** "Bug√ºn X TL yatƒ±rƒ±labilir" (tek g√ºnl√ºk)
        - **Adaptif:** "1-5 Ocak: X TL, 5-31 Ocak: Y TL" (pencere bazlƒ±)
        
        ---
        
        ## üìÅ LSTM Model Kurulumu
        
        ### Mevcut Konfig√ºrasyon:
        ```python
        MODEL_PATH = "{MODEL_PATH}"
        ```
        
        ### Model Hazƒ±rlama:
        ```python
        import base64
        
        # .h5 modelini Base64'e √ßevir
        with open('nakit_akis_lstm_final.h5', 'rb') as f:
            model_bytes = f.read()
            model_base64 = base64.b64encode(model_bytes).decode('utf-8')
        
        # Text dosyasƒ±na kaydet
        with open('model_embedded.txt', 'w') as f:
            f.write(model_base64)
        
        print("‚úÖ model_embedded.txt olu≈üturuldu!")
        ```
        
        ### Google Colab'da:
        ```python
        from google.colab import files
        uploaded = files.upload()  # model_embedded.txt se√ß
        
        # Path doƒüru: /content/model_embedded.txt
        ```
        
        ### Yerel'de:
        ```python
        MODEL_PATH = "model_embedded.txt"  # Aynƒ± klas√∂rde
        # veya
        MODEL_PATH = "C:/Users/Name/models/model_embedded.txt"  # Tam yol
        ```
        
        ---
        
        ## üìä CSV Format √ñrneƒüi
        
        ```csv
        Tarih,Tutar,Aciklama
        2024-10-01,5000,Maa≈ü
        2024-10-02,-1200,Kira
        2024-10-05,-300,Market
        2024-10-10,2000,Proje √ñdemesi
        2024-10-15,-500,Fatura
        ```
        
        **Kurallar:**
        - Pozitif tutar = Giri≈ü
        - Negatif tutar = √áƒ±kƒ±≈ü
        - Tarih: YYYY-MM-DD formatƒ±
        
        ---
        
        ## üé® Yatƒ±rƒ±m Ara√ßlarƒ±
        
        | G√ºn Sayƒ±sƒ± | Ara√ß | √ñrnek |
        |------------|------|-------|
        | 1 g√ºn | üìä Overnight | G√ºnl√ºk repo |
        | 2-7 g√ºn | üìà Haftalƒ±k | Haftalƒ±k repo |
        | 8-30 g√ºn | üè¶ Vadeli 1A | 1 aylƒ±k vadeli |
        | 31-90 g√ºn | üí∞ Vadeli 3A | 3 aylƒ±k vadeli |
        | 90+ g√ºn | üíé Vadeli 6A+ | 6 aylƒ±k+ vadeli |
        
        **Faiz Hesabƒ±:** Yƒ±llƒ±k %45 ‚Üí G√ºnl√ºk %0.123
        
        ---
        
        ## üöÄ En ƒ∞yi Pratikler
        
        1. **D√ºzenli Veri G√ºncelleme**
           - Her hafta yeni i≈ülemleri ekleyin
           - Otomatik yenileme aktif olsun
        
        2. **Buffer Stratejisi**
           - Minimum: Aylƒ±k gider √ó 1
           - √ñnerilen: Aylƒ±k gider √ó 1.5-2
           - G√ºvenli: Aylƒ±k gider √ó 2-3
        
        3. **Risk Y√∂netimi**
           - üü¢ D√º≈ü√ºk risk pencerelerini tercih edin
           - üî¥ Kritik risk varsa buffer'ƒ± artƒ±rƒ±n
           - Negatif bakiye uyarƒ±larƒ±nƒ± ciddiye alƒ±n
        
        4. **Mod√ºl Kombinasyonu**
           - **ƒ∞lk analiz:** Adaptif Pencere
           - **Doƒürulama:** Klasik Analiz
           - **Gelecek:** LSTM Tahmin
        
        5. **Model Kalitesi**
           - LSTM i√ßin en az 60-90 g√ºn veri
           - Her 3 ayda bir modeli yeniden eƒüitin
           - Lookback period: 30 g√ºn (optimal)
        
        ---
        
        ## üîÑ Deƒüi≈üiklik Ge√ßmi≈üi
        
        ### v2.0 (Mevcut)
        - ‚úÖ Otomatik yenileme eklendi
        - ‚úÖ A√ßƒ±k tarih g√∂sterimi eklendi
        - ‚úÖ Grafiklerde negatif b√∂lge vurgusu
        - ‚úÖ Minimum yatƒ±rƒ±m 50 TL'ye d√º≈ü√ºr√ºld√º
        - ‚úÖ Detaylƒ± hata mesajlarƒ±
        
        ### v1.0 (Eski)
        - Temel adaptif pencere analizi
        - LSTM tahmin mod√ºl√º
        - Klasik bakiye takibi
        
        ---
        
        ## üìû Destek
        
        **Kod Yapƒ±sƒ±:**
        - Mod√ºler: LSTM olmadan da √ßalƒ±≈üƒ±r
        - Hata y√∂netimi: Her adƒ±mda try-catch
        - Performans: Verimli pandas operasyonlarƒ±
        
        **Uyumluluk:**
        - ‚úÖ Google Colab
        - ‚úÖ Yerel Python
        - ‚úÖ Streamlit Cloud
        - ‚úÖ Windows/Mac/Linux
        
        ---
        
        ## üí™ Sistem Avantajlarƒ±
        
        ‚úÖ **Adaptif:** Her i≈ülemde otomatik g√ºncelleme
        ‚úÖ **G√∂rsel:** Kƒ±rmƒ±zƒ±/ye≈üil b√∂lge vurgularƒ±
        ‚úÖ **Detaylƒ±:** A√ßƒ±k tarihleri g√∂sterir
        ‚úÖ **Akƒ±llƒ±:** 50 TL'den ba≈ülar, her tutar i√ßin √∂neri
        ‚úÖ **G√ºvenli:** Buffer sistemi ile risk y√∂netimi
        ‚úÖ **Esnek:** 3 farklƒ± analiz mod√ºl√º
        
        ---
        
        ## üéØ Sonu√ß
        
        Bu sistem artƒ±k **tam adaptif**! ƒ∞stediƒüiniz gibi:
        - ‚úÖ Otomatik yenileme
        - ‚úÖ A√ßƒ±k tarih g√∂sterimi
        - ‚úÖ Negatif bakiye vurgusu
        - ‚úÖ K√º√ß√ºk tutarlar i√ßin √∂neri
        
        **Kullanmaya ba≈ülayƒ±n:** 
        1. Veri Sekmesinden CSV y√ºkleyin
        2. Adaptif Pencere'yi √ßalƒ±≈ütƒ±rƒ±n
        3. Manuel i≈ülem ekleyin
        4. üîÑ Otomatik g√ºncellemeyi izleyin!
        
        **ƒ∞yi yatƒ±rƒ±mlar!** üí∞
        """)

if __name__ == "__main__":
    main()
